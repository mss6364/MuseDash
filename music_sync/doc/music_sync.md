## music_sync模块说明

### 监听键盘及音乐播放

该模块实现了一个简单的“按空格播放音频”功能。当模块调用时，用户按下空格立即播放对应音乐，若指定路径中无同名音乐，则播放一段默认节拍。

模块顶部根据当前文件目录计算 BASE_DIR，并定位一个回退默认音频文件 DEFAULT。模块主接口是 **listen_and_play(chart_name)**，它接受一个曲目名或文件路径，若传入的是曲目名则按约定路径 charts/<曲目名>/<曲目名>.mp3 查找音频，找不到时回退到 DEFAULT。

初始化方面，_init_pygame() 用一个模块级布尔变量 pygame_inited 做“只初始化一次”的标志：首次调用时尝试运行 pygame.mixer.init()，成功则把标志设为 True，失败则捕获异常并打印错误信息。该实现避免了重复初始化。

音频播放由 _play_async(path) 完成：先检查路径存在性，然后启动一个守护线程执行加载并播放操作。线程内先调用 _init_pygame() 确保 mixer 已就绪，再用 pygame.mixer.music.load/play() 播放。使用守护线程意味着如果主线程很快退出，播放线程会被强制终止；同时 pygame.mixer.music 是单通道播放，快速连续触发会中断正在播放的音轨，并重新播放音频。

listen_and_play(chart_name) 的主循环使用 keyboard.is_pressed("space") 轮询检测空格按下事件，触发后调用 _play_async 并通过 time.sleep(0.3) 做简单去抖，避免长按重复触发，主循环每次迭代以 0.01s sleep 降低 CPU 占用。按 Ctrl+C 可以中断并退出监听。main() 为调试入口，可调用 listen_and_play 直接运行测试。

- 需要安装的 python 依赖库：`pygame`/`keyboard`

- MuseDash-main 目录下调用调试命令：`python music_sync/player.py songName`



### 软硬件协同方案

- **方案一：PC 键盘 → 软件捕获 → 串口（UART）→ FPGA**
  - 用户通过键盘在 PC 端按下空格键后，软件立即捕获该事件，并通过 UART 串口向 FPGA 发送标准化控制指令帧，例如包含播放启动标志位与 BPM 参数的数据包。FPGA 内部通过 UART 接收模块解析命令，并驱动 Address Generator 与节拍计数器从零时刻开始运行，从而实现音乐播放起始点与谱面滚动的同步。
  - 优点：软硬件接口简单、协议可定制、调试直观、时延可控
  - 缺点：串口本身存在缓冲与时序抖动，时间精度一般，通常在毫秒级
- **方案二：USB HID 键盘直通 FPGA（硬件级 USB 输入）**
  - 将键盘直接接入 FPGA，由 FPGA 作为 USB 主机对 USB HID 键盘进行枚举和轮询，从而绕过 PC 端的操作系统与软件栈，使按键事件直接驱动硬件状态机。结构为键盘 → FPGA USB Host 控制器 → HID 解码 → 播放/节拍控制 FSM。
  - 优点：无串口依赖，时序稳定性好（USB HID 的轮询周期通常固定在 1ms 左右，事件响应路径更短）
  - 缺点：需要在 FPGA 内实现完整的 USB Host 协议栈与 HID 协议解析模块，对逻辑资源和开发经验要求较高，不适合快速原型开发场景
- **方案三：PC 键盘 → 软件 → GPIO 脉冲 → FPGA（低延迟硬件触发）**
  - 这是一种基于 GPIO 的硬件触发方式。该方案中，上位机软件在检测到键盘事件后，通过 USB-GPIO 转换模块或单片机输出一个标准 TTL 电平的短脉冲信号，该脉冲直接接入 FPGA 的通用 I/O 引脚。FPGA 在检测到该引脚的上升沿后立即清零内部计数器并启动播放状态机。
  - 优点：延迟极低（省去串口协议解析过程），同步精准，比串口稳定，适合对实时性要求较高的音乐节奏类应用
  - 缺点：需要额外的硬件接口电路，系统集成时要额外考虑电气兼容性与可靠性
- **方案四：USB HID 设备增加一条“同步通道”（高级软硬件协同）**
  - 这是一种基于 USB 复合设备的同步架构。该方案通过在系统中构建一个同时具有标准 HID 键盘接口和自定义控制接口的 USB 设备，使 FPGA 能够直接通过 USB 通道接收按键数据和专用同步指令。
  - 优点：接口统一、扩展性强，可以在同一物理链路上实现多通道控制和状态反馈，工业设备常用
  - 缺点：需要在 FPGA 内实现 USB Device 协议栈及自定义 HID 报告解析，软硬件复杂度高，实现成本高

综合系统可靠性、实现难度与开发周期等因素，对于当前 MuseDash 系统而言，最适合采用“PC 键盘 → 上位机软件 → UART 串口 → FPGA”这一协同架构。该架构既可以满足基本的播放启动与节拍同步需求，也便于在后续阶段引入时间戳校准机制或硬件脉冲触发机制进行性能优化。通过在 FPGA 端加入简单的串口命令解析逻辑并与现有 Address Generator、Judgement FSM 和 Score Accumulator 模块联动，可以在不大幅增加系统复杂度的前提下，实现稳定可靠的软硬件协同控制效果。
